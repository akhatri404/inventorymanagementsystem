{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container mt-4">
    <!-- <h4 class="mb-3 bg-secondary text-center text-white py-3">ホームダッシュボード</h4> -->
    <!-- Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white p-3 text-center">
                <a href="{% url 'dashboard-products' %}" style="color:white ;" onmouseover="this.style.color='black';"
                    onmouseout="this.style.color='white'">
                    <h5 style="color: white;">すべての商品</h5>
                </a>
                <h3>{{ total_products }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white p-3 text-center">
                <a href="{% url 'dashboard-need-attention' %}" style="color:white;"
                    onmouseover="this.style.color='black';" onmouseout="this.style.color='white'">
                    <h5 style="color: white;">商品の在庫が少ない</h5>
                </a>
                <h3>{{ need_attention|length }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-primary text-white p-3 text-center">
                <a href="{% url 'product_list' %}" style="color:white;" onmouseover="this.style.color='black';"
                    onmouseout="this.style.color='white'">
                    <h5 style="color: white;">合計アクティブ商品</h5>
                </a>
                <h3>{{ total_active }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-white p-3 text-center">
                <a href="{% url 'product_list' %}" style="color:white;" onmouseover="this.style.color='black';"
                    onmouseout="this.style.color='white'">
                    <h5 style="color: white;">合計非アクティブ商品</h5>
                </a>
                <h3>{{ total_inactive }}</h3>
            </div>
        </div>

    </div>

    <!-- Need Attention Modal -->
    <div class="modal fade" id="needAttentionModal" tabindex="-1" aria-labelledby="needAttentionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white d-flex gap-2">
                    <h3 class="modal-title" id="needAttentionModalLabel">注意が必要 ! {{ need_attention|length }} 商品の在庫が少ない
                    </h3>

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- <ul> {% for r in need_attention|slice:":5"  %} 
                        <li>{{ r.product.product_name }} ({{ r.product.yayoi_code }}) — 残週: {{ r.remaining_weeks|floatformat:2 }}</li> 
                        {% endfor %} 
                        <li>...</li>
                    </ul>  -->

                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>弥生</th>
                                <th>商品名</th>
                                <th>残週</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in need_attention|slice:":5" %}
                            <tr>
                                <td>{{ r.product.yayoi_code }}</td>
                                <td>{{ r.product.product_name }}</td>
                                <td>{{ r.remaining_weeks|floatformat:1 }}</td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="3" class="text-center">...　もっと</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="modal-footer">
                    <a href="{% url 'dashboard-need-attention' %}" style="color:red;">Click here to view more
                        details</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <form class="row mb-4">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" placeholder="Search..." value="{{ search }}">
        </div>
        <div class="col-md-3">
            <select name="classification" class="form-select">
                <option value="">- - 分類 - -</option>
                <option value="国外" {% if classification_filter == '国外' %}selected{% endif %}>国外</option>
                <option value="国内" {% if classification_filter == '国内' %}selected{% endif %}>国内</option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="lead_time" class="form-select">
                <option value="">- - LT - -</option>
                <option value="45" {% if lead_time_filter == '45' %}selected{% endif %}>45</option>
                <option value="60" {% if lead_time_filter == '60' %}selected{% endif %}>60</option>
                <option value="45～60" {% if lead_time_filter == '45～60' %}selected{% endif %}>45～60</option>
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-primary w-50">フィルター</button>
            <a href="{% url 'dashboard-home' %}" class="btn btn-secondary w-50"> リセット </a>
            <!-- <a href="{% url 'weekly-summary' %}" class="btn btn-success">すべての週刊</a> -->
        </div>
    </form>

    <!-- Inventory Table -->
    <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
        <h5 class="md-3 fw-bold">最新週の在庫: {{ latest_label }}</h5>
        <div class="d-flex gap-2">
            <a href="{% url 'weekly_bulk_add' %}" class="btn btn-success">
                毎週追加
            </a>
            <a href="{% url 'future_incoming' %}" class="btn btn-warning">将来入荷を追加</a>
        </div>
    </div>

    <table class="table table-hover align-middle table-bordered border-secondary-subtle">
        <thead>
            <tr>
                <th>#</th>
                <th>弥生</th>
                <th>JAN Code</th>
                <th>商品</th>
                <th>月販</th>
                <th>予測</th>
                <th>入庫</th>
                <th>将来入荷</th>
                <th>出庫</th>
                <th>在庫</th>
                <th>残週</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td align="center">{{forloop.counter0|add:start_index|add:1}}</td>
                <td>{{ p.yayoi_code }}</td>
                <td>{{ p.jan_code }}</td>
                <td>{{ p.product_name }}</td>
                <td align="center">{{ p.monthly_sales_prediction|floatformat:0 }}</td>
                <td align="center">{{ p.forecast|floatformat:0 }}</td>
                <td align="center" {% if p.latest_incoming %}style = "background-color: lightgray;" {% endif %}>{{ p.latest_incoming|default:"-" }}</td>
                <td align="center" {% if p.future_incoming %}style = "background-color: orange;" {% endif %}> {{ p.future_incoming|default:"-" }}</td>
                <td align="center">{{ p.latest_outgoing|default:"-" }}</td>
                <td align="center">{{ p.latest_inventory|default:"-" }}</td>
                <td align="center" {% if p.latest_remaining_weeks <= 5%} style = "background-color: lightcoral;" {% endif %} >{{ p.latest_remaining_weeks|floatformat:1|default:"-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            {# Jump to first page #}
            {% if page_obj.number > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page=1&search={{ search }}&classification={{ classification_filter }}&lead_time={{ lead_time_filter }}">
                    First
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">First</span>
            </li>
            {% endif %}

            {# Previous button #}
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}
{% if classification_filter %}&classification={{ classification_filter }}{% endif %}
{% if lead_time_filter %}&lead_time={{ lead_time_filter }}{% endif %}">&laquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {# Show pages in chunks of 6 #}
            {% for num in page_obj.paginator.page_range %}
            {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"3" %} <li
                class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}&search={{ search }}{% if search %}&search={{ search }}{% endif %}
{% if classification_filter %}&classification={{ classification_filter }}{% endif %}
{% if lead_time_filter %}&lead_time={{ lead_time_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {# Next button #}
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}
{% if classification_filter %}&classification={{ classification_filter }}{% endif %}
{% if lead_time_filter %}&lead_time={{ lead_time_filter }}{% endif %}">&raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}

                {# Jump to last page #}
                {% if page_obj.number < page_obj.paginator.num_pages %} <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ search }}">
                        Last
                    </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Last</span>
                    </li>
                    {% endif %}

        </ul>
    </nav>

    <!-- Recently Added -->
    <!-- <h4>Recently Added Products</h4>
    <ul>
        {% for p in recently_added %}
        <li>{{ p.product_name }} ({{ p.jan_code }})</li>
        {% endfor %}
    </ul> -->

</div>

{% if show_need_attention_popup %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var needAttentionModal = new bootstrap.Modal(
            document.getElementById('needAttentionModal')
        );
        needAttentionModal.show();
    });
</script>
{% endif %}

{% if show_recently_added_popup %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var recentlyAddedModal = new bootstrap.Modal(
            document.getElementById('recentlyAddedModal')
        );
        recentlyAddedModal.show();
    });
</script>
{% endif %}

{% endblock %}